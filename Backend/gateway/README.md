# Gateway Service Documentation

## üìã Overview

The Gateway Service is the **single entry point** for all CVAlyze API requests. It acts as a reverse proxy that routes requests to appropriate microservices while handling cross-cutting concerns like authentication, CORS, logging, and monitoring.

### Key Features

- **Centralized API Gateway**: Single entry point for all client requests
- **JWT Authentication**: Token-based authentication middleware protecting all routes
- **Request Routing**: Intelligent routing to User Service and ETL Service
- **CORS Support**: Cross-Origin Resource Sharing for web applications
- **Prometheus Metrics**: Built-in monitoring and observability
- **Structured Logging**: IST timezone-based logging with comprehensive request tracking
- **Log Aggregation**: Centralized access to logs from all microservices
- **Health Checks**: Service availability monitoring

### Technology Stack

- **Framework**: FastAPI
- **Authentication**: JWT (JSON Web Tokens) via python-jose
- **HTTP Client**: httpx (async)
- **Monitoring**: Prometheus FastAPI Instrumentator
- **CORS**: FastAPI CORS Middleware

### Architecture Role

```
Client Applications
        ‚Üì
   API Gateway (Port 8000)
        ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚Üì                ‚Üì
User Service    ETL Service
 (Port 8001)    (Port 8002)
```

The Gateway handles:
- **Authentication & Authorization** for protected endpoints
- **Request forwarding** to appropriate microservices
- **Response aggregation** from multiple services
- **Error handling** and status code management
- **Logging** all API interactions

---

## üîÑ API Versioning

The Gateway Service uses versioned API endpoints to ensure backward compatibility.

**Current Version**: `v1`

All endpoints are prefixed with `/api/v1/`

**Base URL**: `http://localhost:8000` (adjust based on deployment)

---

## üîê Authentication

### JWT Token Authentication

All endpoints except the following require a valid JWT token:
- `/api/v1/register` - User registration
- `/api/v1/login` - User login
- `/api/v1/health` - Health check
- `/docs`, `/redoc`, `/openapi.json` - API documentation
- `/metrics` - Prometheus metrics

### Using Authentication

Include the JWT token in the `Authorization` header:

```bash
Authorization: Bearer <your_jwt_token>
```

### Token Format

Tokens are generated by the User Service and contain:
- **sub**: User identifier (email)
- **exp**: Expiration timestamp
- **iat**: Issued at timestamp

### Token Errors

**Invalid or Missing Token (401 Unauthorized)**
```json
{
  "detail": "Invalid token"
}
```

**Expired Token (401 Unauthorized)**
```json
{
  "detail": "Token is expired or invalid"
}
```

---

## üì° API Endpoints

### 1. Root Endpoint

**GET** `/`

Returns the Gateway service status.

#### Request
```bash
curl -X GET http://localhost:8000/
```

#### Success Response (200 OK)
```json
{
  "message": "Welcome to CVAlyze API Gateway"
}
```

#### Use Case
- Service discovery
- Basic health verification

---

### 2. API v1 Root

**GET** `/api/v1/`

Health check for the versioned API.

#### Request
```bash
curl -X GET http://localhost:8000/api/v1/
```

#### Success Response (200 OK)
```json
{
  "message": "Welcome to CVAlyze API Gateway v1"
}
```

#### Use Case
- Version-specific health check
- API availability confirmation

---

### 3. Health Check

**GET** `/api/v1/health`

üîì **Public Endpoint** - No authentication required

Verify Gateway service health status.

#### Request
```bash
curl -X GET http://localhost:8000/api/v1/health
```

#### Success Response (200 OK)
```json
{
  "status": "healthy"
}
```

#### Use Case
- Load balancer health checks
- Kubernetes liveness/readiness probes
- Monitoring systems

---

### 4. User Registration

**POST** `/api/v1/register`

üîì **Public Endpoint** - No authentication required

Register a new user account. Forwards request to User Service.

#### Request

**Content-Type**: `application/json`

```bash
curl -X POST http://localhost:8000/api/v1/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "john",
    "password": "SecurePass123!"
  }'
```

#### Success Response (201 Created)
```json
{
  "message": "User registered successfully"
}
```

#### Error Responses

**1. User Already Exists (400 Bad Request)**
```json
{
  "detail": "User with this email already exists"
}
```

**2. User Service Unavailable (503 Service Unavailable)**
```json
{
  "detail": "User Service is currently unavailable"
}
```

#### Use Case
- New user account creation
- User onboarding flow

#### Related Service
üìñ **User Service**: [User Registration Documentation](../user_service/README.md#user-registration)

---

### 5. User Login

**POST** `/api/v1/login`

üîì **Public Endpoint** - No authentication required

Authenticate user and receive JWT token. Forwards request to User Service.

#### Request

**Content-Type**: `application/json`

```bash
curl -X POST http://localhost:8000/api/v1/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "john",
    "password": "SecurePass123!"
  }'
```

#### Success Response (200 OK)
```json
{
  "Token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJqb2huLmRvZUBleGFtcGxlLmNvbSIsImV4cCI6MTcwMzA3MzYwMH0.abc123xyz",
  "token_type": "bearer"
}
```

#### Error Responses

**1. Invalid Credentials (401 Unauthorized)**
```json
{
  "detail": "Invalid email or password"
}
```

**2. Missing Fields (422 Unprocessable Entity)**
```json
{
  "detail": [
    {
      "loc": ["body", "email"],
      "msg": "field required",
      "type": "value_error.missing"
    }
  ]
}
```

**3. User Service Unavailable (503 Service Unavailable)**
```json
{
  "detail": "User Service is currently unavailable"
}
```

#### Use Case
- User authentication
- Obtaining access token for protected endpoints
- Session initialization

#### Related Service
üìñ **User Service**: [User Login Documentation](../user_service/README.md#user-login)

---

### 6. Update Password

**PUT** `/api/v1/register`

üîí **Protected Endpoint** - Requires JWT authentication

Update user password. Forwards request to User Service.

#### Request

**Content-Type**: `application/json`  
**Authorization**: `Bearer <token>` (required)

```bash
curl -X PUT http://localhost:8000/api/v1/register \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -d '{
    "email": "john.doe@example.com",
    "oldpassword": "SecurePass123!",
    "newpassword": "NewSecurePass456!"
  }'
```

#### Success Response (200 OK)
```json
{
  "message": "Password updated successfully"
}
```

#### Error Responses

**1. Unauthorized - No Token (401 Unauthorized)**
```json
{
  "detail": "Invalid token"
}
```

**2. Invalid Old Password (401 Unauthorized)**
```json
{
  "detail": "Password is wrong"
}
```

#### Use Case
- User password change
- Security updates
- Password reset flows

#### Related Service
üìñ **User Service**: [Password Update Documentation](../user_service/README.md#update-password)

---

### 7. Delete User Account

**POST** `/api/v1/register/delete`

üîí **Protected Endpoint** - Requires JWT authentication

Delete user account permanently. Forwards request to User Service.

#### Request

**Content-Type**: `application/json`  
**Authorization**: `Bearer <token>` (required)

```bash
curl -X POST http://localhost:8000/api/v1/register/delete \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -d '{
    "username": "john",
    "password": "SecurePass123!"
  }'
```

#### Success Response (200 OK)
```json
{
  "message": "User account deleted successfully"
}
```

#### Error Responses

**1. Unauthorized - No Token (401 Unauthorized)**
```json
{
  "detail": "Invalid token"
}
```

**2. Invalid Password (401 Unauthorized)**
```json
{
  "detail": "Password is wrong"
}
```

**3. User Not Found (404 Not Found)**
```json
{
  "detail": "User not found"
}
```

#### Use Case
- Account deletion/closure
- GDPR compliance (right to be forgotten)
- User offboarding

#### Related Service
üìñ **User Service**: [Account Deletion Documentation](../user_service/README.md#delete-account)

---

### 8. Upload CVs for Processing

**POST** `/api/v1/upload_cvs`

üîí **Protected Endpoint** - Requires JWT authentication

Upload one or multiple CV/Resume files for AI-powered processing. Forwards files to ETL Service.

#### Request

**Content-Type**: `multipart/form-data`  
**Authorization**: `Bearer <token>` (required)

```bash
curl -X POST http://localhost:8000/api/v1/upload_cvs \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -F "files=@resume1.pdf" \
  -F "files=@resume2.docx" \
  -F "files=@resume3.pdf"
```

#### Success Response (200 OK)

Returns extracted CV data with enrichment:

```json
{
  "jsonCv": [
    {
      "name": "John Doe",
      "profession": "Software Engineer",
      "phone_number": "+91-9876543210",
      "email": "john.doe@example.com",
      "location": "Bangalore, Karnataka",
      "github_link": "https://github.com/johndoe",
      "linkedin_link": "https://linkedin.com/in/johndoe",
      "skills": ["Python", "FastAPI", "Docker", "AWS"],
      "education": ["B.Tech in Computer Science ‚Äì ABC University (2016-2020)"],
      "experience": ["Senior Software Engineer ‚Äì Tech Corp"],
      "projects": [
        {
          "name": "AI Resume Parser",
          "links": ["https://github.com/johndoe/resume-parser"]
        }
      ],
      "certifications": ["AWS Certified Solutions Architect"],
      "achievements": ["Led team of 5 developers"],
      "latitude": 12.9716,
      "longitude": 77.5946,
      "country": "India",
      "gender": "male"
    }
  ],
  "errors": []
}
```

#### Error Responses

**1. Unauthorized - No Token (401 Unauthorized)**
```json
{
  "detail": "Invalid token"
}
```

**2. No Files Uploaded (400 Bad Request)**
```json
{
  "detail": "No files were uploaded."
}
```

**3. Empty File (400 Bad Request)**
```json
{
  "detail": "resume2.pdf is empty."
}
```

**4. Unsupported File Type (400 Bad Request)**
```json
{
  "detail": "Unsupported file type: .jpg"
}
```

**5. ETL Service Timeout (504 Gateway Timeout)**
```json
{
  "detail": "ETL service timed out after 2 minutes."
}
```

**6. ETL Service Unavailable (503 Service Unavailable)**
```json
{
  "detail": "ETL Service is currently unavailable"
}
```

**7. Processing Error (500 Internal Server Error)**
```json
{
  "detail": "ETL service request failed: Connection refused"
}
```

#### Processing Details

- **Timeout**: 180 seconds (3 minutes)
- **Supported Formats**: PDF, DOCX, TXT
- **Concurrent Processing**: Multiple files processed simultaneously
- **Data Enrichment**: Automatic geolocation and gender prediction
- **Warehouse Storage**: Data automatically saved to BigQuery
- **Email Notification**: Sent after successful processing

#### Use Case
- Bulk CV processing for recruitment
- Resume database population
- Candidate profile extraction
- Analytics and reporting

#### Related Service
üìñ **ETL Service**: [CV Upload Documentation](../etl_service/README.md#upload-and-process-cvs)

---

### 9. Gateway Logs

**GET** `/logs`

üîì **Public Endpoint** - No authentication required

Retrieve Gateway service logs for monitoring and debugging.

#### Request
```bash
curl -X GET http://localhost:8000/logs --output gateway_logs.log
```

#### Success Response (200 OK)

**Content-Type**: `text/plain`

Returns the log file for download.

**Example Log Content**:
```
2025-10-26 14:30:15 [INFO] gateway: Starting Gateway Service
2025-10-26 14:30:16 [INFO] gateway: Gateway root accessed
2025-10-26 14:35:22 [INFO] gateway: User login attempt
2025-10-26 14:35:23 [INFO] gateway: Login response: 200
2025-10-26 14:35:25 [INFO] gateway: Authenticated user: john.doe@example.com -> /api/v1/upload_cvs
2025-10-26 14:35:26 [INFO] gateway: Uploading 3 files to ETL service
2025-10-26 14:36:45 [INFO] gateway: ETL upload successful with status code: 200
2025-10-26 14:40:12 [WARNING] gateway: Unauthorized access attempt to /api/v1/upload_cvs
```

#### Error Response

**Log File Not Found (404 Not Found)**
```json
{
  "detail": "Log file not found"
}
```

#### Use Case
- Debugging Gateway issues
- Monitoring API usage
- Security audit trails
- Request/response tracking

---

### 10. User Service Logs

**GET** `/logs/user`

üîì **Public Endpoint** - No authentication required

Retrieve logs from User Service via Gateway aggregation.

#### Request
```bash
curl -X GET http://localhost:8000/logs/user --output user_service_logs.log
```

#### Success Response (200 OK)

**Content-Type**: `text/plain`

Returns User Service log file.

#### Error Responses

**1. User Service Unavailable (503 Service Unavailable)**
```json
{
  "detail": "User Service unavailable"
}
```

**2. Failed to Fetch Logs (varies)**
```json
{
  "detail": "Failed to fetch logs"
}
```

#### Use Case
- Centralized log access
- User authentication debugging
- Cross-service troubleshooting

#### Related Service
üìñ **User Service**: [Logs Endpoint Documentation](../user_service/README.md#logs-endpoint)

---

### 11. ETL Service Logs

**GET** `/logs/etl`

üîì **Public Endpoint** - No authentication required

Retrieve logs from ETL Service via Gateway aggregation.

#### Request
```bash
curl -X GET http://localhost:8000/logs/etl --output etl_service_logs.log
```

#### Success Response (200 OK)

**Content-Type**: `text/plain`

Returns ETL Service log file.

#### Error Responses

**1. ETL Service Unavailable (503 Service Unavailable)**
```json
{
  "detail": "ETL Service unavailable"
}
```

**2. Failed to Fetch Logs (varies)**
```json
{
  "detail": "Failed to fetch logs"
}
```

#### Use Case
- Centralized log access
- CV processing debugging
- Cross-service troubleshooting

#### Related Service
üìñ **ETL Service**: [Logs Endpoint Documentation](../etl_service/README.md#view-service-logs)

---

### 12. Prometheus Metrics

**GET** `/metrics`

üîì **Public Endpoint** - No authentication required

Exposes Prometheus-compatible metrics for monitoring.

#### Request
```bash
curl -X GET http://localhost:8000/metrics
```

#### Success Response (200 OK)

**Content-Type**: `text/plain`

Returns Prometheus metrics in text format.

**Example Metrics**:
```
# HELP http_requests_total Total number of HTTP requests
# TYPE http_requests_total counter
http_requests_total{method="POST",path="/api/v1/login",status="200"} 152.0
http_requests_total{method="POST",path="/api/v1/upload_cvs",status="200"} 45.0
http_requests_total{method="GET",path="/api/v1/health",status="200"} 1024.0

# HELP http_request_duration_seconds HTTP request latency
# TYPE http_request_duration_seconds histogram
http_request_duration_seconds_bucket{le="0.1",method="POST",path="/api/v1/login"} 120.0
http_request_duration_seconds_bucket{le="0.5",method="POST",path="/api/v1/login"} 150.0
http_request_duration_seconds_bucket{le="1.0",method="POST",path="/api/v1/login"} 152.0

# HELP gateway_auth_failures_total Total authentication failures
# TYPE gateway_auth_failures_total counter
gateway_auth_failures_total 23.0
```

#### Use Cases
- Integration with Prometheus monitoring
- Grafana dashboards
- SLA monitoring
- Performance analysis

---

## üîß Configuration

### Environment Variables

Create a `.env` file in the Gateway service root:

```env
# JWT Configuration
SECRET_KEY=your_secret_key_for_jwt_signing
ALGORITHM=HS256

# Service URLs (for Docker/Kubernetes)
USER_SERVICE=http://cv-user-service:8001/api/v1
ETL_SERVICE=http://cv-etl-service:8002/api/v1
```

### Service Discovery

The Gateway routes requests to:

| Service | Internal URL | Purpose |
|---------|-------------|---------|
| User Service | `http://cv-user-service:8001/api/v1` | Authentication, user management |
| ETL Service | `http://cv-etl-service:8002/api/v1` | CV processing, data extraction |

---

## üöÄ Running the Service

### Using Docker
```bash
docker build -t gateway-service .
docker run -p 8000:8000 --env-file .env gateway-service
```

### Local Development
```bash
# Install dependencies
pip install -r requirements.txt

# Run with uvicorn
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

---

## üîê Authentication Flow

### 1. User Registration
```
Client ‚Üí Gateway ‚Üí User Service ‚Üí Database
         ‚Üì
      Returns confirmation message
```

### 2. User Login
```
Client ‚Üí Gateway ‚Üí User Service ‚Üí Verify credentials ‚Üí Generate JWT
         ‚Üì
      Returns JWT token
```

### 3. Protected Request
```
Client (with JWT) ‚Üí Gateway (validates JWT) ‚Üí Microservice
                     ‚Üì
                  Forwards with user context
```

### 4. Token Validation
- Token extracted from `Authorization: Bearer <token>` header
- JWT decoded using `SECRET_KEY` and `HS256` algorithm
- User identifier stored in `request.state.user`
- Request forwarded to target service

---

## üõ°Ô∏è Security Features

### Middleware Protection
- **JWT Validation**: All protected endpoints validate tokens
- **Token Expiration**: Expired tokens automatically rejected
- **User Context**: User identity available in all protected routes

### CORS Configuration
```python
allow_origins=["https:cv-alyze.vercel.app"]
allow_credentials=True
allow_methods=["*"]
allow_headers=["*"]
```

**‚ö†Ô∏è Production Recommendation**: Restrict `allow_origins` to specific domains

### Rate Limiting
- Configure at infrastructure level (e.g., API Gateway, Load Balancer)
- Prometheus metrics available for monitoring request rates

---

## üìù Logging

### Log Format
```
YYYY-MM-DD HH:MM:SS [LEVEL] logger_name: message
```

### Log Levels
- **INFO**: Normal operations, request routing
- **WARNING**: Authentication failures, suspicious activity
- **ERROR**: Service communication errors, token errors

### Log Locations
- **File**: `gateway_logs.log` (append mode)
- **Console**: stdout (for container logs)
- **Timezone**: IST (Asia/Kolkata)

### Logged Events
- All API requests with authenticated user
- Authentication failures
- Service routing decisions
- Upstream service errors
- Token validation failures

---

## üîÑ Request Routing

### Routing Table

| Client Request | Routed To | Service Endpoint |
|----------------|-----------|------------------|
| `POST /api/v1/register` | User Service | `POST /api/v1/register` |
| `POST /api/v1/login` | User Service | `POST /api/v1/login` |
| `PUT /api/v1/register` | User Service | `PUT /api/v1/register` |
| `POST /api/v1/register/delete` | User Service | `POST /api/v1/register/delete` |
| `POST /api/v1/upload_cvs` | ETL Service | `POST /api/v1/upload_cvs` |

### Timeout Configuration

| Route | Timeout | Rationale |
|-------|---------|-----------|
| `/register`, `/login`, `/register/*` | Default (10s) | Quick database operations |
| `/upload_cvs` | 180s | Large file processing with AI |

---

## üìä Monitoring

### Prometheus Metrics

Available at `/metrics`:
- **Request counters**: By method, path, status code
- **Latency histograms**: Response time distributions
- **Active connections**: Current concurrent requests
- **Error rates**: Failed request percentages

### Health Checks

| Endpoint | Purpose | Expected Response |
|----------|---------|-------------------|
| `GET /api/v1/health` | Gateway availability | `{"status": "healthy"}` |
| `GET /logs` | Service operational status | Log file (200) or 404 |

---

## üêõ Error Handling

### Gateway-Level Errors

1. **Authentication Failures**
   - Invalid/missing token ‚Üí 401
   - Expired token ‚Üí 401
   - Malformed Authorization header ‚Üí 401

2. **Service Communication Errors**
   - Timeout ‚Üí 504 Gateway Timeout
   - Connection refused ‚Üí 503 Service Unavailable
   - Invalid response ‚Üí 502 Bad Gateway

3. **Request Validation Errors**
   - Empty file uploads ‚Üí 400 Bad Request
   - Missing required fields ‚Üí 422 Unprocessable Entity

### Error Propagation

Gateway forwards status codes and error messages from upstream services:
- User Service errors ‚Üí Returned as-is to client
- ETL Service errors ‚Üí Returned as-is to client
- Network errors ‚Üí Translated to appropriate HTTP status codes

---

## üîó Related Services

- **User Service**: Handles authentication and user management ‚Üí [Documentation](../user_service/README.md)
- **ETL Service**: Processes CVs and extracts data ‚Üí [Documentation](../etl_service/README.md)

---

## üìà Performance Considerations

- **Async HTTP Client**: Non-blocking requests to microservices
- **Connection Pooling**: Reuses HTTP connections via httpx
- **Request Timeout**: Prevents hanging requests
- **CORS Middleware**: Minimal overhead for cross-origin requests
- **JWT Validation**: Fast cryptographic operations

**Typical Latency**:
- Authentication: 50-100ms
- CV Upload: 30-180 seconds (depends on file size and count)
- Log retrieval: 10-50ms

---

## üìû Support

For issues or questions:
- Check Gateway logs: `GET /logs`
- Check service-specific logs: `GET /logs/user` or `GET /logs/etl`
- Review Prometheus metrics: `GET /metrics`
- Open GitHub issue with log excerpts
- Contact: CVAlyze Development Team

---

## üîÑ API Documentation

Interactive API documentation available at:
- **Swagger UI**: `http://localhost:8000/docs`
- **ReDoc**: `http://localhost:8000/redoc`
- **OpenAPI Spec**: `http://localhost:8000/openapi.json`